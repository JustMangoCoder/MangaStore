<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./asset/style/styleProduct.css" />
    <link
      rel="stylesheet"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
    />
    <link rel="stylesheet" href="./asset/style/styleIndex.css" />
    <link rel="stylesheet" href="./asset/style/styleProductBox.css" />

    <link
      href="https://fonts.googleapis.com/css?family=Caveat Brush"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <title>${Name}</title>
  </head>
  <body>
    <div id="TaskBar">
      <a class="LogoSection" onclick="window.location.href = `index.html`"
        ><div class="Logo"><img src="./asset/img/Logo.png" /></div>
        <hr />

        <div class="LogoWatermark">JustMangaStore</div></a
      >
      <div class="ToolSection">
        <a id="Search"><i class="icon bi bi-search"></i></a>
        <a id="Cart"><i class="icon bi bi-cart"></i></a>
      </div>
    </div>
    <div class="SourceSection">
      <a>Home</a>
      <div>/</div>
      <a class="Series"></a>
      <div>/</div>

      <a id="VolumeLink"></a>
    </div>
    <div class="container">
      <div class="containerLayout">
        <div id="ProductImage"></div>
        <div class="ProductSection">
          <h1 class="Name"></h1>
          <div class="StarRating">
            <div>
              <i class="StarIcon bi bi-star-fill"></i>
              <i class="StarIcon bi bi-star-fill"></i>
              <i class="StarIcon bi bi-star-half"></i>
              <i class="StarIcon bi bi-star"></i>
            </div>
            <div style="margin: 0 10px 0 10px">|</div>
            <div style="margin-right: 5px">Đã bán:</div>
            <div style="color: rgba(0, 0, 0, 1)" id="Sold">10</div>
          </div>
          <div class="DescriptionGrid">
            <div class="Description">
              <div>Author:</div>
              <strong id="Author"> </strong>
            </div>
            <div class="Description">
              <div>Publisher:</div>
              <strong id="Publisher"></strong>
            </div>
            <div class="Description">
              <div>Volume:</div>
              <strong id="Volume"></strong>
            </div>
            <div class="Description">
              <div>Part of:</div>
              <strong class="Series"></strong>
            </div>
          </div>
          <div class="Price">
            <h1 id="Price"></h1>
            <div id="PriceBefore"></div>
          </div>
          <div class="Delivery">
            <h2 class="DeliveryTitle">Shipping information</h2>

            <div
              style="
                display: flex;
                flex-direction: row;
                font-size: 14px;
                margin-bottom: 10px;
              "
            >
              <div>Delivery to</div>
              <div id="DeliveryLocation">
                Phường Bến Nghé, Quận 1, Hồ Chí Minh
              </div>
              <a id="Change">Change</a>
            </div>
            <div id="DeliverySpeed">
              <select style="margin-bottom: 10px">
                <option value="1">
                  <i class="fa-regular fa-truck" style="font-size: 16px"></i>
                  <span><strong>Standard Delivery</strong></span>
                </option>
                <option value="2">
                  <i class="fa-regular fa-truck" style="font-size: 16px"></i>
                  <span><strong>Faster Delivery</strong></span>
                </option>
              </select>
              <div style="margin-left: 22px">
                <span>Expected delivery: </span>
                <strong id="DeliveryDate"></strong>
              </div>
            </div>
          </div>
          <div class="ProductQuanity">
            <label class="QuanityLabel">Quanity:</label>
            <div class="Quanity">
              <button
                class="QuanityButton minus"
                type="button"
                onclick="Decrease()"
              >
                <i class="bi bi-dash"></i>
              </button>
              <input type="text" value="1" class="QuanityInput" />
              <button
                class="QuanityButton plus"
                type="button"
                onclick="Increase()"
              >
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
          <div class="Button">
            <button id="AddToCart">
              <span><i class="fa-solid fa-basket-shopping"></i></span>
              <span>Add to Cart</span>
            </button>
            <button id="Buy">
              <span><i class="fa-regular fa-money-bill-1"></i></span>
              <span>Buy now</span>
            </button>
          </div>
          <h3>Detail information</h3>
          <div class="Detail">
            <div class="BulletPoint">Product code</div>
            <div id="ProductCode"></div>
            <div class="BulletPoint">Author</div>
            <div id="Author2"></div>
            <div class="BulletPoint">Publisher</div>
            <div id="Publisher2"></div>
            <div class="BulletPoint">Publish Year</div>
            <div id="PublishYear">23</div>
            <div class="BulletPoint">Page</div>
            <div id="PageNumber"></div>
          </div>
          <div class="Summary">
            <h4>Summary</h4>
            <div class="Name"></div>
            <p id="Summary"></p>
          </div>
        </div>
      </div>
    </div>
    <div class="SameSeries">
      <h3 class="Series" id="RelatedTitle"></h3>

      <hr />
      <div id="RelatedSection"></div>
    </div>

    <script>
      // Increase And Decrease Input
      let qty = document.querySelector(".QuanityInput");
      function Decrease() {
        if (qty.value <= 1) {
          qty.value = 1;
        } else {
          qty.value = parseInt(qty.value) - 1;
        }
      }
      function Increase() {
        qty.value = parseInt(qty.value) + 1;
      }
    </script>
    <script
      src="https://kit.fontawesome.com/cfe2659f79.js"
      crossorigin="anonymous"
    ></script>
    <script type="module">
      import { getAuth } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore-lite.js";
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyA4qqrJ1zZ6NkufDcBtfRrHpr_S3RkG-H4",
        authDomain: "mangastore-9268b.firebaseapp.com",
        projectId: "mangastore-9268b",
        storageBucket: "mangastore-9268b.firebasestorage.app",
        messagingSenderId: "190342870546",
        appId: "1:190342870546:web:411c9b58d14a85a47f4acb",
        measurementId: "G-JV9VN7T01V",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const db = getFirestore();

      //Load Data
      const params = new URLSearchParams(window.location.search);
      const productId = params.get("id");
      const docRef = doc(db, "Manga", productId);
      const docSnap = await getDoc(docRef);

      const product = docSnap.data();
      document.getElementById("RelatedTitle").innerHTML += "Other ";

      document
        .querySelectorAll(".Name")
        .forEach((el) => (el.innerHTML += product.Name));
      document
        .querySelectorAll(".Series")
        .forEach((el) => (el.innerHTML += product.Series));
      document.getElementById("RelatedTitle").innerHTML += " volumes";

      document.getElementById("ProductImage").innerHTML =
        `          <img src="${product.img}" alt="" />
            `;
      document.getElementById("Author").innerHTML = product.Author;
      document.getElementById("Author2").innerHTML = product.Author;
      document.getElementById("Publisher").innerHTML = product.Publish;
      document.getElementById("ProductCode").innerHTML = productId;
      document.getElementById("Publisher2").innerHTML = product.Publish;
      document.getElementById("PublishYear").innerHTML =
        product.PublishDate.toDate().toLocaleDateString("vi-VN");
      console.log(product.PublishDate);
      document.getElementById("Volume").innerHTML = product.Volume;
      document.getElementById("PriceBefore").innerHTML =
        product.PriceBefore.toLocaleString() + " ₫";
      document.getElementById("Price").innerHTML =
        product.Price.toLocaleString() + " ₫";
      document.getElementById("PageNumber").innerHTML = product.PageNumber;
      document.getElementById("Summary").innerHTML = product.Summary;
      document.getElementById("VolumeLink").innerHTML =
        "Volume " + product.Volume;
      document.getElementById("Sold").innerHTML = product.Sold;
      const deliveryDays = product.DeliveryDay; // e.g. 20

      const deliveryDate = new Date(); // today
      deliveryDate.setDate(deliveryDate.getDate() + deliveryDays);
      document.getElementById("DeliveryDate").innerHTML =
        deliveryDate.toLocaleDateString("vi-VN");

      // Load Related Series
      const RelatedList = {};
      const querySnapshot = await getDocs(collection(db, "Manga"));

      querySnapshot.forEach((doc) => {
        RelatedList[doc.id] = doc.data();
      });
      const currentProduct = docSnap.data();

      Object.keys(RelatedList).forEach((id) => {
        const relatedProduct = RelatedList[id];

        if (
          relatedProduct.Series === currentProduct.Series &&
          id !== productId
        ) {
          console.log(relatedProduct);
          document.getElementById("RelatedSection").innerHTML += `
                          <a  class="product-link" data-id="${id}">
      <div class="ProductBox">
                <div>
                  <img src="${relatedProduct.img}" alt="" />
                </div>
                <div class="ProductContent">
                  <div class="ProductName">${relatedProduct.Name}</div>
                  <div>${relatedProduct.Author}</div>
                  <div class="StarRating">
                    ${StarRating(relatedProduct.Rating)}
                  </div>

                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; gap:5px;">
                      <div class="Price">
                        ${relatedProduct.Price.toLocaleString()} ₫
                      </div>
                      <div class="BeforePrice">
                        ${relatedProduct.PriceBefore.toLocaleString()} ₫
                      </div>
                    </div>
                    <button class="BuyButton">Buy</button>
                  </div>
                </div>
              </div>
            </a>
          `;
        }
      });

      function StarRating(rating) {
        let starsHTML = "";
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        for (let i = 1; i <= 5; i++) {
          if (i <= fullStars) {
            starsHTML += `<span> <i class="Star bi bi-star-fill"></i></span>`;
          } else if (i === fullStars + 1 && hasHalfStar) {
            starsHTML += `<span> <i class=" Star bi bi-star-half"></i></span>`;
          } else {
            starsHTML += `<span> <i class="Star bi bi-star"></i></span>`;
          }
        }

        return starsHTML;
      }
      document.querySelectorAll(".product-link").forEach((link) => {
        link.addEventListener("click", () => {
          const id = link.dataset.id;
          window.location.href = `product.html?id=${id}`;
        });
      });
      document.getElementById("AddToCart").addEventListener("click", addToCart)
      async function addToCart() {
        const user = auth.currentUser;

        if (!user) {
          alert("Please login first");
          return;
        }

        const uid = user.uid;
        const qty = Number(document.querySelector(".QuanityInput").value) || 1;

        const userRef = doc(db, "users", uid);

        await updateDoc(userRef, {
          [`Cart.${productId}`]: qty,
        });

        console.log("Added to cart:", productId, qty);
      }
    </script>
  </body>
</html>
