<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ComicStore Offical</title>
    <link rel="stylesheet" href="./asset/style/styleIndex.css" />

    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Caveat Brush"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="./asset/style/styleProductBox.css" />

    <link rel="icon" href="./asset/img/Logo.png" />
  </head>
  <body>
    <div class="WholePage">
      <div id="TaskBar">
        <a class="LogoSection"
          ><div class="Logo"><img src="./asset/img/Logo.png" /></div>
          <hr />

          <div class="LogoWatermark">JustMangaStore</div></a
        >
        <div class="DropSection">
          <a id="Series" class="DropButton" data-type="series">
            Series
            <span
              ><i class="bi bi-chevron-down Arrow" data-type="series"></i></span
          ></a>
          <a id="Recent" class="DropButton" data-type="recent">
            Recent <span><i class="bi bi-chevron-down Arrow"></i></span>
          </a>
          <div class="DropContainer hide" id="Drop"></div>
        </div>
        <div class="ToolSection">
          <a id="Search"><i class="icon bi bi-search"></i></a>
          <a id="Cart" onclick="window.location.href = './cart.html'"
            ><i class="icon bi bi-cart"></i
          ></a>
          <a id="User" onclick="window.location.href = './login.html'"
            ><i class="icon bi bi-person"></i
          ></a>
        </div>
      </div>

      <div><img class="IndexImage" src="./asset/img/TitleCard.png" /></div>
      <div id="TrendingPage" class="ProductDisplay">
        <div class="TitleHeader">
          <h2>Trending</h2>
          <div style="justify-self: end">
            <button class="ScrollButton" id="ScrollLeft"><</button>
            <button class="ScrollButton" id="ScrollRight">></button>
          </div>
        </div>
        <div class="ProductIndexSection" id="TrendingSection"></div>
      </div>
    </div>
    <script type="module">
      import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
        updateDoc,
        
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore-lite.js";
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyA4qqrJ1zZ6NkufDcBtfRrHpr_S3RkG-H4",
        authDomain: "mangastore-9268b.firebaseapp.com",
        projectId: "mangastore-9268b",
        storageBucket: "mangastore-9268b.firebasestorage.app",
        messagingSenderId: "190342870546",
        appId: "1:190342870546:web:411c9b58d14a85a47f4acb",
        measurementId: "G-JV9VN7T01V",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const db = getFirestore();
      //Get Data
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("✅ Signed in as:", user.email);
        } else {
          console.log("❌ Not signed in");
        }
      });
      const ProductList = {};
      const querySnapshot = await getDocs(collection(db, "Manga"));
      querySnapshot.forEach((doc) => {
        ProductList[doc.id] = {
          id: doc.id,
          ...doc.data(),
        };
      });
      const trendingSection = document.getElementById("TrendingSection");
      trendingSection.innerHTML = "";

      Object.keys(ProductList).forEach((id) => {
        const product = ProductList[id];

        trendingSection.innerHTML += `
                      <a  class="product-link" data-id="${id}"
                    ><div class="ProductBox">
                      <div><img src="${product.img}" alt="" /></div>
                      <div class="ProductContent">
                        <div class="ProductName">
                          ${product.Name}
                        </div>
                        <div class="">
                          ${product.Author}
                        </div>
                        <div class="StarRating">
                          ${StarRating(product.Rating)}
                        </div>
                        <div
                          style="
                            display: flex;
                            flex-direction: row;
                            justify-content: space-between;
                            align-items: center;
                          "
                        >
                          <div  style="
                            display: flex;
                            flex-direction: row;
                            justify-content: flex-start;
                            align-items: center;
                            gap:5px
                          "><div class="Price">${product.Price.toLocaleString()} ₫</div>
                          <div class="BeforePrice">${product.PriceBefore.toLocaleString()} ₫</div></div>
                          <span><button class="BuyButton">Buy</button></span>
                        </div>
                      </div>
                    </div></a
                  >
                    `;
      });
      function StarRating(rating) {
        let starsHTML = "";
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        for (let i = 1; i <= 5; i++) {
          if (i <= fullStars) {
            starsHTML += `<span> <i class="Star bi bi-star-fill"></i></span>`;
          } else if (i === fullStars + 1 && hasHalfStar) {
            starsHTML += `<span> <i class=" Star bi bi-star-half"></i></span>`;
          } else {
            starsHTML += `<span> <i class="Star bi bi-star"></i></span>`;
          }
        }

        return starsHTML;
      }

      

      // Move to Product Page
      document.querySelectorAll(".product-link").forEach((link) => {
        link.addEventListener("click", () => {
          const id = link.dataset.id;
          window.location.href = `./product.html?id=${id}`;
        });
      });
      //Extract Series
      //Series
      const uniqueSeries = [
        ...new Set(
          querySnapshot.docs.map((doc) => doc.data().Series).filter(Boolean),
        ),
      ];
      //Recent

      //Drop Animation
      document.querySelectorAll(".DropButton").forEach((button) => {
        button.addEventListener("mouseenter", () => {
          Show(button.dataset.type);
        });
      });
      document.getElementById("Drop").addEventListener("mouseleave", Hide);

      function Show(ButtonName) {
        document.getElementById("Drop").classList.remove("hide");
        document.querySelector(".Arrow").classList.remove("bi-chevron-down");
        document.querySelector(".Arrow").classList.add("bi-chevron-up");

        if (ButtonName == "series") {
          Drop.innerHTML = "";
          console.log("Series");
          for (let i = 0; i < uniqueSeries.length; i++) {
            RenderSameManga(uniqueSeries[i]);
          }
        }
        if (ButtonName == "recent") {
          Drop.innerHTML = "";
          console.log("Series");
          RenderLatestManga();
        }
      }

      function RenderSameManga(uniqueSeries) {
        const Drop = document.getElementById("Drop");
        const PickManga = Object.values(ProductList).filter(
          (manga) => manga.Series === uniqueSeries,
        );

        const randomManga =
          PickManga[Math.floor(Math.random() * PickManga.length)];
        Drop.innerHTML += `<a class="ItemInside"   onclick="window.location.href='./product.html?id=${randomManga.id}'">

                    <div class="ItemInsideImage">
                      <img src="${randomManga.img}" alt="" />
                    </div>
                    <div>${randomManga.Series}</div>
                  </a>
              `;
      }
      function RenderLatestManga(count = 5) {
        const SeriesTime = querySnapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        SeriesTime.sort(
          (a, b) => new Date(b.PublishDate) - new Date(a.PublishDate),
        ).slice(0, count);
        for (let i = 0; i < SeriesTime.length; i++) {
          Drop.innerHTML += `<a class="ItemInside"      onclick="window.location.href='./product.html?id=${SeriesTime[i].id}'">

                    <div class="ItemInsideImage">
                      <img src="${SeriesTime[i].img}" alt="" />
                    </div>
                    <div>${SeriesTime[i].Name}</div>
                  </a>
              `;
        }
      }
      function Hide() {
        document.getElementById("Drop").classList.add("hide");
        document.querySelector(".Arrow").classList.remove("bi-chevron-up");
        document.querySelector(".Arrow").classList.add("bi-chevron-down");
        return;
      }
    </script>
    <script>
      const trendingSection = document.getElementById("TrendingSection");

      document.getElementById("ScrollLeft").addEventListener("click", () => {
        trendingSection.scrollBy({
          left: -300,
          behavior: "smooth",
        });
      });
      document.getElementById("ScrollRight").addEventListener("click", () => {
        trendingSection.scrollBy({
          left: 300,
          behavior: "smooth",
        });
      });
    </script>
  </body>
</html>
